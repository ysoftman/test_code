<div
  id="tag-cloud-container"
  style="line-height: 1.5em; padding: 0px; text-align: justify"
>
  <span>loading tags...</span>
</div>

<script type="text/javascript">
  (function () {
    var CACHE_KEY = "blogTagCloud";
    var CACHE_TTL = 60 * 60 * 1000; // 1시간
    var tagMap = {};
    var batchSize = 150; // Blogger API max-results 제한
    var hasCachedData = false;

    function escapeHtml(str) {
      var escapeMap = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      };
      return str.replace(/[&<>"']/g, function (c) {
        return escapeMap[c];
      });
    }

    function showError(message) {
      document.getElementById("tag-cloud-container").innerHTML =
        '<span style="color: #e06c75">' + escapeHtml(message) + "</span>";
    }

    function getCache() {
      try {
        var cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
          var data = JSON.parse(cached);
          if (Date.now() - data.timestamp < CACHE_TTL) {
            return data.tagMap;
          }
        }
      } catch (e) {}
      return null;
    }

    function setCache(map) {
      try {
        localStorage.setItem(
          CACHE_KEY,
          JSON.stringify({ tagMap: map, timestamp: Date.now() }),
        );
      } catch (e) {}
    }

    function processEntries(entries) {
      if (!entries) return;
      for (var i = 0; i < entries.length; i++) {
        var categories = entries[i].category;
        if (categories) {
          for (var j = 0; j < categories.length; j++) {
            var name = categories[j].term;
            tagMap[name] = (tagMap[name] || 0) + 1;
          }
        }
      }
    }

    function renderTagCloud(map) {
      var tagData = [];
      var counts = [];
      for (var name in map) {
        if (Object.prototype.hasOwnProperty.call(map, name)) {
          tagData.push({
            name: name,
            count: map[name],
            url: "/search/label/" + encodeURIComponent(name),
          });
          counts.push(map[name]);
        }
      }

      if (tagData.length === 0) {
        document.getElementById("tag-cloud-container").innerHTML =
          '<span style="color: #abb2bf">태그가 없습니다.</span>';
        return;
      }

      tagData.sort(function (a, b) {
        return a.name.localeCompare(b.name);
      });

      var max = Math.max.apply(null, counts);
      var min = Math.min.apply(null, counts);

      var colors = [
        "#abb2bf",
        "#61afef",
        "#56b6c2",
        "#98c379",
        "#e5c07b",
        "#c678dd",
        "#e06c75",
      ];

      // 고유 카운트 기반 순위로 색상 배분 (같은 카운트 = 같은 색상)
      var uniqueCounts = counts
        .slice()
        .sort(function (a, b) {
          return a - b;
        })
        .filter(function (v, i, arr) {
          return i === 0 || v !== arr[i - 1];
        });
      var countRankMap = {};
      for (var i = 0; i < uniqueCounts.length; i++) {
        countRankMap[uniqueCounts[i]] = i;
      }

      var html = "";
      for (var i = 0; i < tagData.length; i++) {
        var tag = tagData[i];
        var countWeight = max === min ? 0 : (tag.count - min) / (max - min);
        var rankWeight =
          uniqueCounts.length <= 1
            ? 0
            : countRankMap[tag.count] / (uniqueCounts.length - 1);
        var fontSize = 1 + countWeight * 1.5;
        var colorIndex = Math.floor(rankWeight * (colors.length - 1));
        var color = colors[colorIndex];
        var fontWeight = countWeight > 0.5 ? "bold" : "500";
        var escapedName = escapeHtml(tag.name);

        html +=
          '<a href="' +
          tag.url +
          '" class="t-link" style="font-size:' +
          fontSize +
          "em; color:" +
          color +
          "; font-weight:" +
          fontWeight +
          ';">' +
          escapedName +
          '<span class="t-count">' +
          tag.count +
          "</span></a> ";
      }

      document.getElementById("tag-cloud-container").innerHTML = html;
    }

    function fetchJSON(startIndex) {
      return fetch(
        "/feeds/posts/summary?alt=json" +
          "&start-index=" +
          startIndex +
          "&max-results=" +
          batchSize,
      )
        .then(function (response) {
          if (!response.ok) throw new Error("HTTP " + response.status);
          return response.json();
        });
    }

    // 캐시 확인 후 즉시 렌더링
    var cached = getCache();
    if (cached) {
      hasCachedData = true;
      renderTagCloud(cached);
    }

    // 백그라운드에서 최신 데이터 가져오기
    fetchJSON(1)
      .then(function (json) {
        var totalPosts = parseInt(json.feed.openSearch$totalResults.$t, 10);
        processEntries(json.feed.entry);
        renderTagCloud(tagMap);

        if (totalPosts <= batchSize) {
          setCache(tagMap);
          return;
        }

        var totalBatches = Math.ceil((totalPosts - batchSize) / batchSize);
        var promises = [];
        for (var i = 1; i <= totalBatches; i++) {
          promises.push(fetchJSON(1 + i * batchSize));
        }

        return Promise.all(promises).then(function (results) {
          for (var i = 0; i < results.length; i++) {
            processEntries(results[i].feed.entry);
          }
          renderTagCloud(tagMap);
          setCache(tagMap);
        });
      })
      .catch(function () {
        if (!hasCachedData) {
          showError("태그를 불러오지 못했습니다.");
        }
      });
  })();
</script>

<style>
  #tag-cloud-container {
    font-family:
      "Fira code", "FiraCode", "Consolas", "Monaco", "Courier New", monospace;
  }
  .t-link {
    position: relative;
    margin-right: 20px;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s ease-in-out;
    white-space: nowrap;
  }
  .t-link:hover {
    transform: scale(1.1);
    z-index: 10;
  }
  /* 태그 개수 스타일 */
  .t-count {
    font-size: 0.6em;
    vertical-align: super;
    margin-left: 4px;
    opacity: 0.7;
    font-weight: normal;
  }
</style>
